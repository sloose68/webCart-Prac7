import{em as C,en as k,hg as Re,ar as Ae,jA as pe,jI as S,eD as be,am as F,d1 as v,aY as te,ao as m,bf as Fe,jJ as Ee,eo as ne}from"./index-C4I_fUP4.js";import{v as Ne,b as oe,s as le,a as X,k as re,N as J,H as ie,E as $,U as f}from"./sphere-BBFmkJym.js";import{G as ge,M as p,h as Me,p as I}from"./plane-BevxFgKZ.js";import{f as Se,r as Be}from"./vectorStacks-xHxTx1Ui.js";import{i as de}from"./BufferView-D6JhfiNJ.js";function Y(n){return n?{ray:oe(n.ray),c0:n.c0,c1:n.c1}:{ray:oe(),c0:0,c1:Number.MAX_VALUE}}function Ve(n,e=Y()){return Ne(n,e.ray),e.c0=0,e.c1=Number.MAX_VALUE,e}function We(n,e){return ce(n,n.c0,e)}function Xe(n,e){return ce(n,n.c1,e)}function ce(n,e,t){return C(t,n.ray.origin,k(t,n.ray.direction,e))}new le((()=>Y()));function Qe(n){return n?[p(n[0]),p(n[1]),p(n[2]),p(n[3]),p(n[4]),p(n[5])]:[p(),p(),p(),p(),p(),p()]}function je(){return[F(),F(),F(),F(),F(),F(),F(),F()]}function Ye(n,e){for(let t=0;t<Z;t++)Me(n[t],e[t]);return n}function Ze(n,e,t,o=Ie){const r=Re(Se.get(),e,n);Ae(r,r);for(let s=0;s<Pe;++s){const h=pe(Be.get(),He[s],r);be(o[s],h[0]/h[3],h[1]/h[3],h[2]/h[3])}xe(t,o)}function xe(n,e){I(e[i.FAR_BOTTOM_LEFT],e[i.NEAR_BOTTOM_LEFT],e[i.NEAR_TOP_LEFT],n[B.LEFT]),I(e[i.NEAR_BOTTOM_RIGHT],e[i.FAR_BOTTOM_RIGHT],e[i.FAR_TOP_RIGHT],n[B.RIGHT]),I(e[i.FAR_BOTTOM_LEFT],e[i.FAR_BOTTOM_RIGHT],e[i.NEAR_BOTTOM_RIGHT],n[B.BOTTOM]),I(e[i.NEAR_TOP_LEFT],e[i.NEAR_TOP_RIGHT],e[i.FAR_TOP_RIGHT],n[B.TOP]),I(e[i.NEAR_BOTTOM_LEFT],e[i.NEAR_BOTTOM_RIGHT],e[i.NEAR_TOP_RIGHT],n[B.NEAR]),I(e[i.FAR_BOTTOM_RIGHT],e[i.FAR_BOTTOM_LEFT],e[i.FAR_TOP_LEFT],n[B.FAR])}function y(n,e){for(let t=0;t<Z;t++){const o=n[t];if(o[0]*e[0]+o[1]*e[1]+o[2]*e[2]+o[3]>=e[3])return!1}return!0}function et(n,e){for(let t=0;t<Z;t++){const o=n[t];if(!ge(o,e))return!1}return!0}var B,i;(function(n){n[n.LEFT=0]="LEFT",n[n.RIGHT=1]="RIGHT",n[n.BOTTOM=2]="BOTTOM",n[n.TOP=3]="TOP",n[n.NEAR=4]="NEAR",n[n.FAR=5]="FAR"})(B||(B={})),(function(n){n[n.NEAR_BOTTOM_LEFT=0]="NEAR_BOTTOM_LEFT",n[n.NEAR_BOTTOM_RIGHT=1]="NEAR_BOTTOM_RIGHT",n[n.NEAR_TOP_RIGHT=2]="NEAR_TOP_RIGHT",n[n.NEAR_TOP_LEFT=3]="NEAR_TOP_LEFT",n[n.FAR_BOTTOM_LEFT=4]="FAR_BOTTOM_LEFT",n[n.FAR_BOTTOM_RIGHT=5]="FAR_BOTTOM_RIGHT",n[n.FAR_TOP_RIGHT=6]="FAR_TOP_RIGHT",n[n.FAR_TOP_LEFT=7]="FAR_TOP_LEFT"})(i||(i={}));i.FAR_BOTTOM_RIGHT,i.NEAR_BOTTOM_RIGHT,i.NEAR_BOTTOM_LEFT,i.FAR_BOTTOM_LEFT,i.NEAR_BOTTOM_LEFT,i.NEAR_BOTTOM_RIGHT,i.NEAR_TOP_RIGHT,i.NEAR_TOP_LEFT,i.FAR_BOTTOM_RIGHT,i.FAR_BOTTOM_LEFT,i.FAR_TOP_LEFT,i.FAR_TOP_RIGHT,i.NEAR_BOTTOM_RIGHT,i.FAR_BOTTOM_RIGHT,i.FAR_TOP_RIGHT,i.NEAR_TOP_RIGHT,i.FAR_BOTTOM_LEFT,i.NEAR_BOTTOM_LEFT,i.NEAR_TOP_LEFT,i.FAR_TOP_LEFT,i.FAR_TOP_LEFT,i.NEAR_TOP_LEFT,i.NEAR_TOP_RIGHT,i.FAR_TOP_RIGHT;const Z=6,Pe=8,He=[S(-1,-1,-1,1),S(1,-1,-1,1),S(1,1,-1,1),S(-1,1,-1,1),S(-1,-1,1,1),S(1,-1,1,1),S(1,1,1,1),S(-1,1,1,1)];new le(Y);const Ie=je();class L{get bounds(){return this._root.bounds}get halfSize(){return this._root.halfSize}get root(){return this._root.node}get maximumObjectsPerNode(){return this._maximumObjectsPerNode}get maximumDepth(){return this._maximumDepth}get objectCount(){return this._objectCount}constructor(e,t){this.objectToBoundingSphere=e,this._maximumObjectsPerNode=10,this._maximumDepth=20,this._degenerateObjects=new Set,this._root=new c,this._objectCount=0,t&&(t.maximumObjectsPerNode!==void 0&&(this._maximumObjectsPerNode=t.maximumObjectsPerNode),t.maximumDepth!==void 0&&(this._maximumDepth=t.maximumDepth))}destroy(){this._degenerateObjects.clear(),c.clearPool(),Q[0]=null,P.prune(),H.prune()}add(e){const t=Array.from(e);this._grow(t);const o=c.acquire();for(const r of t)++this._objectCount,this._isDegenerate(r)?this._degenerateObjects.add(r):(o.init(this._root),this._add(r,o));c.release(o)}remove(e,t=null){this._objectCount-=e.length;const o=c.acquire();for(const r of e){const s=t??X(this.objectToBoundingSphere(r),Ce);D(s[3])?(o.init(this._root),Le(r,s,o)):this._degenerateObjects.delete(r)}c.release(o),this._shrink()}update(e,t){if(!D(t[3])&&this._isDegenerate(e))return;const o=we(e);this.remove(o,t),this.add(o)}forEachAlongRay(e,t,o){const r=re(e,t);x(this._root,(s=>{if(!ze(r,s))return!1;const h=s.node;return h.terminals.forAll((l=>{this._intersectsObject(r,l)&&o(l)})),h.residents!==null&&h.residents.forAll((l=>{this._intersectsObject(r,l)&&o(l)})),!0}))}forEachAlongRayWithVerticalOffset(e,t,o,r){const s=re(e,t);x(this._root,(h=>{if(!Ge(s,h,r))return!1;const l=h.node;return l.terminals.forAll((a=>{this._intersectsObjectWithOffset(s,a,r)&&o(a)})),l.residents!==null&&l.residents.forAll((a=>{this._intersectsObjectWithOffset(s,a,r)&&o(a)})),!0}))}forEach(e){x(this._root,(t=>{const o=t.node;return o.terminals.forAll(e),o.residents!==null&&o.residents.forAll(e),!0})),this._degenerateObjects.forEach(e)}forEachDegenerateObject(e){this._degenerateObjects.forEach(e)}findClosest(e,t,o,r=()=>!0,s=1/0){let h=1/0,l=1/0,a=null;const d=K(e,t),T=u=>{if(--s,!r(u))return;const O=this.objectToBoundingSphere(u);if(!y(o,O))return;const E=j(e,t,f(O)),z=E-O[3],_=E+O[3];z<h&&(h=z,l=_,a=u)};return se(this._root,(u=>{if(s<=0||!y(o,u.bounds)||(k(b,d,u.halfSize),C(b,b,f(u.bounds)),j(e,t,b)>l))return!1;const O=u.node;return O.terminals.forAll((E=>T(E))),O.residents!==null&&O.residents.forAll((E=>T(E))),!0}),e,t),a}forEachInDepthRange(e,t,o,r,s,h,l){let a=-1/0,d=1/0;const T={setRange:_=>{o===L.DepthOrder.FRONT_TO_BACK?(a=Math.max(a,_.near),d=Math.min(d,_.far)):(a=Math.max(a,-_.far),d=Math.min(d,-_.near))}};T.setRange(r);const u=j(t,o,e),O=K(t,o),E=K(t,-o),z=_=>{if(!l(_))return;const M=this.objectToBoundingSphere(_),G=f(M),ee=j(t,o,G)-u,me=ee-M[3],Oe=ee+M[3];me>d||Oe<a||!y(h,M)||s(_,T)};se(this._root,(_=>{if(!y(h,_.bounds)||(k(b,O,_.halfSize),C(b,b,f(_.bounds)),j(t,o,b)-u>d)||(k(b,E,_.halfSize),C(b,b,f(_.bounds)),j(t,o,b)-u<a))return!1;const M=_.node;return M.terminals.forAll((G=>z(G))),M.residents!==null&&M.residents.forAll((G=>z(G))),!0}),t,o)}forEachNode(e){x(this._root,(t=>e(t.node,t.bounds,t.halfSize,t.depth)))}forEachNeighbor(e,t){const o=J(t),r=f(t),s=a=>{const d=this.objectToBoundingSphere(a),T=J(d),u=o+T;return!(ne(f(d),r)-u*u<=0)||e(a)};let h=!0;const l=a=>{h&&(h=s(a))};x(this._root,(a=>{const d=J(a.bounds),T=o+d;if(ne(f(a.bounds),r)-T*T>0)return!1;const u=a.node;return u.terminals.forAll(l),h&&u.residents!==null&&u.residents.forAll(l),h})),h&&this.forEachDegenerateObject(l)}_intersectsObject(e,t){const o=this.objectToBoundingSphere(t);return!(o[3]>0)||ie(o,e)}_intersectsObjectWithOffset(e,t,o){const r=this.objectToBoundingSphere(t);return!(r[3]>0)||ie(o.applyToBoundingSphere(r),e)}_add(e,t){t.advanceTo(this.objectToBoundingSphere(e))?t.node.terminals.push(e):(t.node.residents.push(e),t.node.residents.length>this._maximumObjectsPerNode&&t.depth<this._maximumDepth&&this._split(t))}_split(e){const t=e.node.residents;e.node.residents=null;for(let o=0;o<t.length;o++){const r=c.acquire().init(e);this._add(t.at(o),r),c.release(r)}}_grow(e){if(ae(e,(t=>this.objectToBoundingSphere(t)),N),D(N[3])&&!this._fitsInsideTree(N))if(_e(this._root.node))X(N,this._root.bounds),this._root.halfSize=1.25*this._root.bounds[3],this._root.updateBoundsRadiusFromHalfSize();else{const t=this._rootBoundsForRootAsSubNode(N);this._placingRootViolatesMaxDepth(t)?this._rebuildTree(N,t):this._growRootAsSubNode(t),c.release(t)}}_rebuildTree(e,t){te(f(V),f(t.bounds)),V[3]=t.halfSize,ae([e,V],(r=>r),W);const o=c.acquire().init(this._root);this._root.initFrom(null,W,W[3]),this._root.increaseHalfSize(1.25),x(o,(r=>(this.add(r.node.terminals.data),r.node.residents!==null&&this.add(r.node.residents.data),!0))),c.release(o)}_placingRootViolatesMaxDepth(e){const t=Math.log(e.halfSize/this._root.halfSize)*Math.LOG2E;let o=0;return x(this._root,(r=>(o=Math.max(o,r.depth),o+t<=this._maximumDepth))),o+t>this._maximumDepth}_rootBoundsForRootAsSubNode(e){const t=e[3],o=e;let r=-1/0;const s=this._root.bounds,h=this._root.halfSize;for(let a=0;a<3;a++){const d=s[a]-h-(o[a]-t),T=o[a]+t-(s[a]+h),u=Math.max(0,Math.ceil(d/(2*h))),O=Math.max(0,Math.ceil(T/(2*h)))+1,E=2**Math.ceil(Math.log(u+O)*Math.LOG2E);r=Math.max(r,E),w[a].min=u,w[a].max=O}for(let a=0;a<3;a++){let d=w[a].min,T=w[a].max;const u=(r-(d+T))/2;d+=Math.ceil(u),T+=Math.floor(u);const O=s[a]-h-d*h*2;U[a]=O+(T+d)*h}const l=r*h;return U[3]=l*Te,c.acquire().initFrom(null,U,l,0)}_growRootAsSubNode(e){const t=this._root.node;te(f(N),f(this._root.bounds)),N[3]=this._root.halfSize,this._root.init(e),e.advanceTo(N,null,!0),e.node.children=t.children,e.node.residents=t.residents,e.node.terminals=t.terminals}_shrink(){for(;;){const e=this._findShrinkIndex();if(e===-1)break;this._root.advance(e),this._root.depth=0}}_findShrinkIndex(){if(this._root.node.terminals.length!==0||this._root.isLeaf())return-1;let e=null;const t=this._root.node.children;let o=0,r=0;for(;r<t.length&&e==null;)o=r++,e=t[o];for(;r<t.length;)if(t[r++])return-1;return o}_isDegenerate(e){return!D(this.objectToBoundingSphere(e)[3])}_fitsInsideTree(e){const t=this._root.bounds,o=this._root.halfSize;return e[3]<=o&&e[0]>=t[0]-o&&e[0]<=t[0]+o&&e[1]>=t[1]-o&&e[1]<=t[1]+o&&e[2]>=t[2]-o&&e[2]<=t[2]+o}toJSON(){const{maximumDepth:e,maximumObjectsPerNode:t,_objectCount:o}=this,r=this._nodeToJSON(this._root.node);return{maximumDepth:e,maximumObjectsPerNode:t,objectCount:o,root:{bounds:this._root.bounds,halfSize:this._root.halfSize,depth:this._root.depth,node:r}}}_nodeToJSON(e){const t=e.children.map((s=>s?this._nodeToJSON(s):null)),o=e.residents?.map((s=>this.objectToBoundingSphere(s))),r=e.terminals?.map((s=>this.objectToBoundingSphere(s)));return{children:t,residents:o,terminals:r}}static fromJSON(e){const t=new L((o=>o),{maximumDepth:e.maximumDepth,maximumObjectsPerNode:e.maximumObjectsPerNode});return t._objectCount=e.objectCount,t._root.initFrom(e.root.node,e.root.bounds,e.root.halfSize,e.root.depth),t}}const g=class g{constructor(){this.bounds=$(),this.halfSize=0,this.initFrom(null,null,0,0)}init(e){return this.initFrom(e.node,e.bounds,e.halfSize,e.depth)}initFrom(e,t,o,r=this.depth){return this.node=e??g.createEmptyNode(),t&&X(t,this.bounds),this.halfSize=o,this.depth=r,this}increaseHalfSize(e){this.halfSize*=e,this.updateBoundsRadiusFromHalfSize()}updateBoundsRadiusFromHalfSize(){this.bounds[3]=this.halfSize*Te}advance(e){let t=this.node.children[e];t||(t=g.createEmptyNode(),this.node.children[e]=t),this.node=t,this.halfSize/=2,this.depth++;const o=fe[e];return this.bounds[0]+=o[0]*this.halfSize,this.bounds[1]+=o[1]*this.halfSize,this.bounds[2]+=o[2]*this.halfSize,this.updateBoundsRadiusFromHalfSize(),this}advanceTo(e,t,o=!1){for(;;){if(this.isTerminalFor(e))return t&&t(this,-1),!0;if(this.isLeaf()){if(!o)return t&&t(this,-1),!1;this.node.residents=null}const r=this._childIndex(e);t&&t(this,r),this.advance(r)}}isLeaf(){return this.node.residents!=null}isTerminalFor(e){return e[3]>this.halfSize/2}_childIndex(e){const t=this.bounds;return(t[0]<e[0]?1:0)+(t[1]<e[1]?2:0)+(t[2]<e[2]?4:0)}static createEmptyNode(){return{children:[null,null,null,null,null,null,null,null],terminals:new v({shrink:!0}),residents:new v({shrink:!0})}}static acquire(){return g._pool.acquire()}static release(e){g._pool.release(e)}static clearPool(){g._pool.prune()}};g._pool=new Fe(g);let c=g;function x(n,e){let t=c.acquire().init(n);const o=[t];for(;o.length!==0;){if(t=o.pop(),e(t)&&!t.isLeaf())for(let r=0;r<t.node.children.length;r++)t.node.children[r]&&o.push(c.acquire().init(t).advance(r));c.release(t)}}function se(n,e,t,o=L.DepthOrder.FRONT_TO_BACK){let r=c.acquire().init(n);const s=[r];for(ye(t,o,ue);s.length!==0;){if(r=s.pop(),e(r)&&!r.isLeaf())for(let h=7;h>=0;--h){const l=ue[h];r.node.children[l]&&s.push(c.acquire().init(r).advance(l))}c.release(r)}}function Le(n,e,t){P.clear();const o=t.advanceTo(e,((r,s)=>{P.push(r.node),P.push(s)}))?t.node.terminals:t.node.residents;if(o.removeUnordered(n),o.length===0)for(let r=P.length-2;r>=0&&$e(P.data[r],P.data[r+1]);r-=2);}function $e(n,e){return e>=0&&(n.children[e]=null),!!_e(n)&&(n.residents===null&&(n.residents=new v({shrink:!0})),!0)}function ze(n,e){return q(f(e.bounds),2*-e.halfSize,R),q(f(e.bounds),2*e.halfSize,A),de(n.origin,n.direction,R,A)}function Ge(n,e,t){return q(f(e.bounds),2*-e.halfSize,R),q(f(e.bounds),2*e.halfSize,A),t.applyToMinMax(R,A),de(n.origin,n.direction,R,A)}function _e(n){if(n.terminals.length!==0)return!1;if(n.residents!==null)return n.residents.length===0;for(let e=0;e<n.children.length;e++)if(n.children[e])return!1;return!0}function De(n,e){n[0]=Math.min(n[0],e[0]-e[3]),n[1]=Math.min(n[1],e[1]-e[3]),n[2]=Math.min(n[2],e[2]-e[3])}function ve(n,e){n[0]=Math.max(n[0],e[0]+e[3]),n[1]=Math.max(n[1],e[1]+e[3]),n[2]=Math.max(n[2],e[2]+e[3])}function q(n,e,t){t[0]=n[0]+e,t[1]=n[1]+e,t[2]=n[2]+e}function ae(n,e,t){R[0]=1/0,R[1]=1/0,R[2]=1/0,A[0]=-1/0,A[1]=-1/0,A[2]=-1/0;for(const o of n){const r=e(o);D(r[3])&&(De(R,r),ve(A,r))}Ee(f(t),R,A,.5),t[3]=Math.max(A[0]-R[0],A[1]-R[1],A[2]-R[2])/2}function ye(n,e,t){if(!H.length)for(let o=0;o<8;++o)H.push({index:0,distance:0});for(let o=0;o<8;++o){const r=fe[o];H.data[o].index=o,H.data[o].distance=j(n,e,r)}H.sort(((o,r)=>o.distance-r.distance));for(let o=0;o<8;++o)t[o]=H.data[o].index}function K(n,e){let t,o=1/0;for(let r=0;r<8;++r){const s=j(n,e,he[r]);s<o&&(o=s,t=he[r])}return t}function j(n,e,t){return e*(n[0]*t[0]+n[1]*t[1]+n[2]*t[2])}function D(n){return!isNaN(n)&&n!==-1/0&&n!==1/0&&n>0}(function(n){var e;(e=n.DepthOrder||(n.DepthOrder={}))[e.FRONT_TO_BACK=1]="FRONT_TO_BACK",e[e.BACK_TO_FRONT=-1]="BACK_TO_FRONT"})(L||(L={}));const fe=[m(-1,-1,-1),m(1,-1,-1),m(-1,1,-1),m(1,1,-1),m(-1,-1,1),m(1,-1,1),m(-1,1,1),m(1,1,1)],he=[m(-1,-1,-1),m(-1,-1,1),m(-1,1,-1),m(-1,1,1),m(1,-1,-1),m(1,-1,1),m(1,1,-1),m(1,1,1)],Te=Math.sqrt(3),Q=[null];function we(n){return Q[0]=n,Q}const U=$(),b=F(),R=F(),A=F(),P=new v,Ce=$(),N=$(),V=$(),W=$(),w=[{min:0,max:0},{min:0,max:0},{min:0,max:0}],H=new v,ue=[0,0,0,0,0,0,0,0];export{Qe as H,Ze as L,Ye as N,Y as a,L as b,Xe as g,B as j,et as m,We as p,Ve as y};
