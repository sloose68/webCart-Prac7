const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/loader-DqKMrDWU.js","assets/ScaleRangeLayer-CkcnxI7v.js","assets/mat4f64-q_b6UJoq.js","assets/quat-DZtsjC15.js","assets/mat3f64-B5o_lm6j.js","assets/quatf64-aQ5IuZRd.js","assets/BufferView-CcUKtSfw.js","assets/resourceUtils-B2ZY7b-A.js","assets/basicInterfaces-N86vRvDz.js"])))=>i.map(i=>d[i]);
import{kq as Te,kr as be,iH as K,gJ as we,jo as ne,b5 as Q,ad as oe,ae as ve,a6 as ae,t as $e,dc as Y,gK as ie,ko as q,d as Re,ks as Me,_ as Ae,b9 as Oe,b4 as H,eO as Z,ez as Be,kt as J,eM as Se,br as Pe,jk as Ie,ee as ue,ku as Ee,gY as ke,gZ as X,g_ as _e}from"./ScaleRangeLayer-CkcnxI7v.js";import{n as W,e as le}from"./mat3f64-B5o_lm6j.js";import{e as Ce}from"./mat4f64-q_b6UJoq.js";import{L as ce,p as fe,n as F}from"./OutputColorHighlightOID.glsl-DzI-_NNG.js";import{o as me,T as de,g as Ue,M as je,O as Fe,V as Le}from"./BufferView-CcUKtSfw.js";import{r as qe,n as Ne,d as ee,l as te}from"./vec3-CMvs1Nu9.js";import{o as Ve,d as re}from"./vec4-wHUUxhSp.js";import{n as De,o as Ge,a as He}from"./indexUtils-0y9QvtqA.js";import{n as L}from"./resourceUtils-B2ZY7b-A.js";import{t as We}from"./NestedMap-wm1q4thl.js";import{A as ze}from"./Indices-HRVG5CyY.js";import{t as Ke}from"./requestImageUtils-CjrqjyK5.js";import{t as k}from"./orientedBoundingBox-C19z4-Aj.js";import{e as z,i as R,n as Qe}from"./basicInterfaces-N86vRvDz.js";import{e as I}from"./VertexAttribute-BfkzOMLV.js";import{W as N,n as Ye,o as Ze,s as Je,t as Xe}from"./RealisticTree.glsl-DzhRMLzx.js";import{a as se}from"./NormalAttribute.glsl-Bjarj0Tp.js";function _(r){if(r==null)return null;const t=r.offset!=null?r.offset:Te,n=r.rotation!=null?r.rotation:0,s=r.scale!=null?r.scale:be,l=W(1,0,0,0,1,0,t[0],t[1],1),i=W(Math.cos(n),-Math.sin(n),0,Math.sin(n),Math.cos(n),0,0,0,1),o=W(s[0],0,0,0,s[1],0,0,0,1),a=le();return K(a,i,o),K(a,l,a),a}class et{constructor(){this.geometries=new Array,this.materials=new Array,this.textures=new Array}}class tt{constructor(t,n,s){this.name=t,this.lodThreshold=n,this.pivotOffset=s,this.stageResources=new et,this.numberOfVertices=0}}const O=()=>$e.getLogger("esri.views.3d.layers.graphics.objectResourceUtils");class rt{constructor(t,n,s){this.resource=t,this.textures=n,this.cachedMemory=s}}async function st(r,t){const n=await nt(r,t),s=await lt(n.textureDefinitions??{},t);let l=0;for(const i in s)if(s.hasOwnProperty(i)){const o=s[i];l+=o?.image?o.image.width*o.image.height*4:0}return new rt(n,s,l+we(n))}async function nt(r,t){const n=t?.streamDataRequester;if(n)return ot(r,n,t);const s=await oe(ve(r,t));if(s.ok===!0)return s.value.data;ae(s.error),pe(s.error)}async function ot(r,t,n){const s=await oe(t.request(r,"json",n));if(s.ok===!0)return s.value;ae(s.error),pe(s.error.details.url)}function pe(r){throw new Re("",`Request for object resource failed: ${r}`)}function at(r){const t=r.params,n=t.topology;let s=!0;switch(t.vertexAttributes||(O().warn("Geometry must specify vertex attributes"),s=!1),t.topology){case"PerAttributeArray":break;case"Indexed":case null:case void 0:{const i=t.faces;if(i){if(t.vertexAttributes)for(const o in t.vertexAttributes){const a=i[o];a?.values?(a.valueType!=null&&a.valueType!=="UInt32"&&(O().warn(`Unsupported indexed geometry indices type '${a.valueType}', only UInt32 is currently supported`),s=!1),a.valuesPerElement!=null&&a.valuesPerElement!==1&&(O().warn(`Unsupported indexed geometry values per element '${a.valuesPerElement}', only 1 is currently supported`),s=!1)):(O().warn(`Indexed geometry does not specify face indices for '${o}' attribute`),s=!1)}}else O().warn("Indexed geometries must specify faces"),s=!1;break}default:O().warn(`Unsupported topology '${n}'`),s=!1}r.params.material||(O().warn("Geometry requires material"),s=!1);const l=r.params.vertexAttributes;for(const i in l)l[i].values||(O().warn("Geometries with externally defined attributes are not yet supported"),s=!1);return s}function it(r,t){const n=new Array,s=new Array,l=new Array,i=new We,o=r.resource,a=ne.parse(o.version||"1.0","wosr");ft.validate(a);const f=o.model.name,e=o.model.geometries,u=o.materialDefinitions??{},c=r.textures;let h=0;const g=new Map;for(let x=0;x<e.length;x++){const m=e[x];if(!at(m))continue;const b=ct(m),T=m.params.vertexAttributes,w=[],p=d=>{if(m.params.topology==="PerAttributeArray")return null;const $=m.params.faces;for(const y in $)if(y===d)return $[y].values;return null},v=T[I.POSITION],C=v.values.length/v.valuesPerElement;for(const d in T){const $=T[d],y=$.values,D=p(d)??ze(C);w.push([d,new k(y,D,$.valuesPerElement,!0)])}const M=b.texture,S=c&&c[M];if(S&&!g.has(M)){const{image:d,parameters:$}=S,y=new ce(d,$);s.push(y),g.set(M,y)}const U=g.get(M),V=U?U.id:void 0,A=b.material;let B=i.get(A,M);if(B==null){const d=u[A.slice(A.lastIndexOf("/")+1)].params;d.transparency===1&&(d.transparency=0);const $=S?ge(S.alphaChannelUsage):void 0,y={ambient:Q(d.diffuse),diffuse:Q(d.diffuse),opacity:1-(d.transparency||0),textureAlphaMode:$,textureAlphaCutoff:.33,textureId:V,doubleSided:!0,cullFace:z.None,colorMixMode:d.externalColorMixMode||"tint",textureAlphaPremultiplied:S?.parameters.preMultiplyAlpha??!1};t?.materialParameters&&Object.assign(y,t.materialParameters),B=new N(y,t),i.set(A,M,B)}l.push(B);const j=new fe(B,w);h+=w.find((d=>d[0]===I.POSITION))?.[1]?.indices.length??0,n.push(j)}return{engineResources:[{name:f,stageResources:{textures:s,materials:l,geometries:n},pivotOffset:o.model.pivotOffset,numberOfVertices:h,lodThreshold:null}],referenceBoundingBox:ut(n)}}function ut(r){const t=ie();return r.forEach((n=>{const s=n.boundingInfo;s!=null&&(q(t,s.bbMin),q(t,s.bbMax))})),t}async function lt(r,t){const n=new Array;for(const i in r){const o=r[i],a=o.images[0].data;if(!a){O().warn("Externally referenced texture data is not yet supported");continue}const f=o.encoding+";base64,"+a,e="/textureDefinitions/"+i,u=o.channels==="rgba"?o.alphaChannelUsage||"transparency":"none",c={noUnpackFlip:!0,wrap:{s:Y.REPEAT,t:Y.REPEAT},preMultiplyAlpha:ge(u)!==R.Opaque},h=t?.disableTextures?Promise.resolve(null):Ke(f,t);n.push(h.then((g=>({refId:e,image:g,parameters:c,alphaChannelUsage:u}))))}const s=await Promise.all(n),l={};for(const i of s)l[i.refId]=i;return l}function ge(r){switch(r){case"mask":return R.Mask;case"maskAndTransparency":return R.MaskBlend;case"none":return R.Opaque;default:return R.Blend}}function ct(r){const t=r.params;return{id:1,material:t.material,texture:t.texture,region:t.texture}}const ft=new ne(1,2,"wosr");async function mt(r,t){const n=he(Me(r));if(n.fileType==="wosr"){const c=await(t.cache?t.cache.loadWOSR(n.url,t):st(n.url,t)),{engineResources:h,referenceBoundingBox:g}=it(c,t);return{lods:h,referenceBoundingBox:g,isEsriSymbolResource:!1,isWosr:!0}}let s;if(t.cache)s=await t.cache.loadGLTF(n.url,t,!!t.usePBR);else{const{loadGLTF:c}=await Ae(()=>import("./loader-DqKMrDWU.js"),__vite__mapDeps([0,1,2,3,4,5,6,7,8]));s=await c(new De(t.streamDataRequester),n.url,t,t.usePBR)}const l=s.model.meta?.ESRI_proxyEllipsoid,i=s.meta.isEsriSymbolResource&&l!=null&&s.meta.ESRI_webstyle==="EsriRealisticTreesStyle";i&&!s.customMeta.esriTreeRendering&&(s.customMeta.esriTreeRendering=!0,xt(s,l));const o=!!t.usePBR,a=s.meta.isEsriSymbolResource?{usePBR:o,isSchematic:!1,treeRendering:i,mrrFactors:Je}:{usePBR:o,isSchematic:!1,treeRendering:!1,mrrFactors:Xe},f={...t.materialParameters,treeRendering:i},{engineResources:e,referenceBoundingBox:u}=dt(s,a,f,t,n.specifiedLodIndex,i);return{lods:e,referenceBoundingBox:u,isEsriSymbolResource:s.meta.isEsriSymbolResource,isWosr:!1}}function he(r){const t=r.match(/(.*\.(gltf|glb))(\?lod=([0-9]+))?$/);return t?{fileType:"gltf",url:t[1],specifiedLodIndex:t[4]!=null?Number(t[4]):null}:r.match(/(.*\.(json|json\.gz))$/)?{fileType:"wosr",url:r,specifiedLodIndex:null}:{fileType:"unknown",url:r,specifiedLodIndex:null}}function dt(r,t,n,s,l,i){const o=r.model,a=new Array,f=new Map,e=new Map,u=o.lods.length,c=ie();return o.lods.forEach(((h,g)=>{const x=s.skipHighLods===!0&&(u>1&&g===0||u>3&&g===1)||s.skipHighLods===!1&&l!=null&&g!==l;if(x&&g!==0)return;const m=new tt(h.name,h.lodThreshold,[0,0,0]);h.parts.forEach((b=>{const T=x?new N({},s):pt(o,b,m,t,n,f,e,s,i),{geometry:w,vertexCount:p}=gt(b,T??new N({},s)),v=w.boundingInfo;v!=null&&g===0&&(q(c,v.bbMin),q(c,v.bbMax)),T!=null&&(m.stageResources.geometries.push(w),m.numberOfVertices+=p)})),x||a.push(m)})),{engineResources:a,referenceBoundingBox:c}}function pt(r,t,n,s,l,i,o,a,f){const e=r.materials.get(t.material);if(e==null)return null;const{normal:u,color:c,texCoord0:h,tangent:g}=t.attributes,x=t.material+(u?"_normal":"")+(c?"_color":"")+(h?"_texCoord0":"")+(g?"_tangent":""),m=t.attributes.texCoord0!=null,b=t.attributes.normal!=null,T=ht(e.alphaMode);if(!i.has(x)){if(m){const d=(y,D=!1,xe=!1)=>{if(y!=null&&!o.has(y)){const G=r.textures.get(y);if(G){const P=G.data,ye=D&&!L(P)?a.compressionOptions:void 0;o.set(y,new ce(L(P)?P.data:P,{...G.parameters,preMultiplyAlpha:!L(P)&&xe,encoding:L(P)?P.encoding:void 0,compressionOptions:ye}))}}},$=T!==R.Opaque&&!f;d(e.colorTexture,$,T!==R.Opaque),d(e.normalTexture),d(e.occlusionTexture,!0),d(e.emissiveTexture),d(e.metallicRoughnessTexture,!0)}const p=1/ue,v=e.color[0]**p,C=e.color[1]**p,M=e.color[2]**p,S=e.emissiveFactor[0]**p,U=e.emissiveFactor[1]**p,V=e.emissiveFactor[2]**p,A=e.colorTexture!=null&&m?o.get(e.colorTexture):null,B=Ye(e),j=e.normalTextureTransform?.scale!=null?e.normalTextureTransform?.scale:Ee;i.set(x,new N({...s,customDepthTest:Qe.Lequal,textureAlphaMode:T,textureAlphaCutoff:e.alphaCutoff,diffuse:[v,C,M],ambient:[v,C,M],opacity:e.alphaMode==="OPAQUE"?1:e.opacity,doubleSided:e.doubleSided,doubleSidedType:"winding-order",cullFace:e.doubleSided?z.None:z.Back,hasVertexColors:!!t.attributes.color,hasVertexTangents:!!t.attributes.tangent,normalType:b?se.Attribute:se.ScreenDerivative,castShadows:!0,receiveShadows:e.receiveShadows,receiveAmbientOcclusion:e.receiveAmbientOcclusion,textureId:A?.id,colorMixMode:e.colorMixMode,normalTextureId:e.normalTexture!=null&&m?o.get(e.normalTexture).id:void 0,textureAlphaPremultiplied:A!=null&&!!A.parameters.preMultiplyAlpha,occlusionTextureId:e.occlusionTexture!=null&&m?o.get(e.occlusionTexture).id:void 0,emissiveTextureId:e.emissiveTexture!=null&&m?o.get(e.emissiveTexture).id:void 0,metallicRoughnessTextureId:e.metallicRoughnessTexture!=null&&m?o.get(e.metallicRoughnessTexture).id:void 0,emissiveBaseColor:[S,U,V],mrrFactors:B?Ze:[e.metallicFactor,e.roughnessFactor,s.mrrFactors[2]],isSchematic:B,colorTextureTransformMatrix:_(e.colorTextureTransform),normalTextureTransformMatrix:_(e.normalTextureTransform),scale:[j[0],j[1]],occlusionTextureTransformMatrix:_(e.occlusionTextureTransform),emissiveTextureTransformMatrix:_(e.emissiveTextureTransform),metallicRoughnessTextureTransformMatrix:_(e.metallicRoughnessTextureTransform),...l},a))}const w=i.get(x);if(n.stageResources.materials.push(w),m){const p=v=>{v!=null&&n.stageResources.textures.push(o.get(v))};p(e.colorTexture),p(e.normalTexture),p(e.occlusionTexture),p(e.emissiveTexture),p(e.metallicRoughnessTexture)}return w}function gt(r,t){const n=r.attributes.position.count,s=Ge(r.indices||n,r.primitiveType),l=F(3*n),{typedBuffer:i,typedBufferStride:o}=r.attributes.position;qe(l,i,r.transform,3,o);const a=[[I.POSITION,new k(l,s,3,!0)]];if(r.attributes.normal!=null){const e=F(3*n),{typedBuffer:u,typedBufferStride:c}=r.attributes.normal;ke(E,r.transform),Ne(e,u,E,3,c),X(E)&&ee(e,e),a.push([I.NORMAL,new k(e,s,3,!0)])}if(r.attributes.tangent!=null){const e=F(4*n),{typedBuffer:u,typedBufferStride:c}=r.attributes.tangent;_e(E,r.transform),Ve(e,u,E,4,c),X(E)&&ee(e,e,4),a.push([I.TANGENT,new k(e,s,4,!0)])}if(r.attributes.texCoord0!=null){const e=F(2*n),{typedBuffer:u,typedBufferStride:c}=r.attributes.texCoord0;He(e,u,2,c),a.push([I.UV0,new k(e,s,2,!0)])}const f=r.attributes.color;if(f!=null){const e=new Uint8Array(4*n);f.elementCount===4?f instanceof de?re(e,f,1,255):(f instanceof Ue||f instanceof je)&&re(e,f,1/255,255):(e.fill(255),f instanceof me?te(e,f.typedBuffer,1,255,4,f.typedBufferStride):(r.attributes.color instanceof Fe||r.attributes.color instanceof Le)&&te(e,f.typedBuffer,1/255,255,4,r.attributes.color.typedBufferStride)),a.push([I.COLOR,new k(e,s,4,!0)])}return{geometry:new fe(t,a),vertexCount:n}}const E=le();function ht(r){switch(r){case"BLEND":return R.Blend;case"MASK":return R.Mask;case"OPAQUE":case null:case void 0:return R.Opaque}}function xt(r,t){for(let n=0;n<r.model.lods.length;++n){const s=r.model.lods[n];for(const l of s.parts){const i=l.attributes.normal;if(i==null)return;const o=l.attributes.position,a=o.count,f=H(),e=H(),u=H(),c=new Float32Array(4*a),h=new Float32Array(3*a),g=Oe(Ce(),l.transform);let x=0,m=0;for(let b=0;b<a;b++){o.getVec(b,e),i.getVec(b,f),Z(e,e,l.transform),Be(u,e,t.center),J(u,u,t.radius);const T=u[2],w=Se(u),p=Math.min(.45+.55*w*w,1)**ue;J(u,u,t.radius),g!==null&&Z(u,u,g),Pe(u,u),n+1!==r.model.lods.length&&r.model.lods.length>1&&Ie(u,u,f,T>-1?.2:Math.min(-4*T-3.8,1)),h[x]=u[0],h[x+1]=u[1],h[x+2]=u[2],x+=3,c[m]=p,c[m+1]=p,c[m+2]=p,c[m+3]=1,m+=4}l.attributes.normal=new me(h),l.attributes.color=new de(c)}}}const Ct=Object.freeze(Object.defineProperty({__proto__:null,fetch:mt,parseUrl:he},Symbol.toStringTag,{value:"Module"}));export{mt as Y,Ct as o,_ as s};
